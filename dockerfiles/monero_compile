FROM ubuntu:22.04 AS og

ENV DEBIAN_FRONTEND noninteractive

WORKDIR /opt/monero

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential cmake pkg-config libboost-all-dev \
    libssl-dev libzmq3-dev libunbound-dev libsodium-dev libpgm-dev git wget

# Build args
ARG THREADS 2
ARG MONERO_RELEASE v0.18.4.4

# Clone monero repo
RUN git clone https://github.com/monero-project/monero --branch=$MONERO_RELEASE --depth=1 .

# Clone submodules
RUN git submodule update --init --force

# Compile monero
RUN make -j$THREADS

FROM ubuntu:22.04

WORKDIR /data

COPY --from=og /usr/lib/x86_64-linux-gnu/ /usr/lib/x86_64-linux-gnu/
COPY --from=og /opt/monero/build/Linux/_no_branch_/release/bin/monerod /bin/monerod
COPY --from=og /opt/monero/build/Linux/_no_branch_/release/bin/monero-wallet-cli /bin/monero-wallet-cli
COPY --from=og /opt/monero/build/Linux/_no_branch_/release/bin/monero-wallet-rpc /bin/monero-wallet-rpc
COPY ./dockerfiles/files/monerod/ban_list.txt /ban_list.txt
COPY ./dockerfiles/files/monerod/monerod_entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 18080
EXPOSE 18081
EXPOSE 18082
EXPOSE 18083
